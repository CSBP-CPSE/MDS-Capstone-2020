---
title: "ltc_logistic_regression"
author: "NL"
date: "26/05/2020"
output:
  html_document: default
  pdf_document: default
---
## Import the data
```{r }
library(skimr)

# Import the data
df <- read.csv("merged_LTC_odhf_quality.csv", na.strings="", header=TRUE)
skim(df)
```


```{r }
# Add a column with outbreak status
df$outbreak <- with(df, ifelse(is.na(status), 'no', 'yes'))

# Add a column of LHIN health regions
unique(df[['LHIN']])
df$region[df$LHIN=='North West' | df$LHIN=='North East'] <- "North"
df$region[df$LHIN=='Toronto Central'] <- "Toronto"
df$region[df$LHIN=='Champlain' | df$LHIN=='Central East' | df$LHIN=='South East'] <- "East"
df$region[df$LHIN=='Erie St. Clair' | df$LHIN=='Hamilton Niagara Haldimand Brant (Hnhb)' | df$LHIN=='South West' | df$LHIN=='Waterloo Wellington'] <- "West"
df$region[df$LHIN=='Mississauga Halton' | df$LHIN=='Central West' | df$LHIN=='Central' | df$LHIN=='North Simcoe Muskoka'] <- "Central"

# # Combine categories of Municipal and Non-profit for home_type
# df$home_type[df$home_type == 'Municipal'] <- 'Non-Profit'
# df$home_type <- factor(df$home_type)

# # Create new columns
# # Sum of complaints and critical
# df$total_cc <- df$total_critical + df$total_complaints
# df$X5y_cc <- df$X5y_complaints + df$X5y_critical
# df$X2y_cc <- df$X2y_complaints + df$X2y_critical
# 
# # Sum of complaints, critical and withOrders
# df$total_ccw <- df$total_critical + df$total_complaints + df$total_withOrders
# df$X5y_ccw <- df$X5y_complaints + df$X5y_critical + df$X5y_withOrders
# df$X2y_ccw <- df$X2y_complaints + df$X2y_critical + df$X2y_withOrders

# Add columns with numbers of non-complaints inspections
df$total_noncomplaints <- df$total_inspections - df$total_complaints
df$X5y_noncomplaints <- df$X5y_inspections - df$X5y_complaints
df$X2y_noncomplaints <- df$X2y_inspections - df$X2y_complaints

skim(df)
```


```{r }
# Update data types for some columns
df[, 'outbreak'] <- as.factor(df[, 'outbreak'])
df[, 'region'] <- as.factor(df[, 'region'])

# Change data type of character
listofcol = list('name', 'cleaned_name', 'address', 'city', 'postal_code', 'CSDname')
for (each in listofcol){
  df[, each] <- as.character(df[, each])
}

skim(df)

```


```{r }
# Create list of columns used to filter data for analysis
profile = c("short_stay", "residents_council", "family_council", "accreditation")
keep = c("home_type", "number_beds")
location = c('address', 'LHIN', 'city', 'postal_code', 'CSDname', 'CSDuid', 'latitude', 'longitude') 
all_inspections = c("total_inspections", "X5y_inspections", "X2y_inspections") 
complaints = c("total_complaints", "X5y_complaints", "X2y_complaints")
critical = c("total_critical", "X5y_critical", "X2y_critical") 
noncomplaints = c("total_noncomplaints", "X5y_noncomplaints", "X2y_noncomplaints")
withOrders = c("total_withOrders", "X5y_withOrders", "X2y_withOrders")
# cc_ccw = c("total_cc", "X5y_cc", "X2y_cc", "total_ccw", "X5y_ccw", "X2y_ccw")
covid = c("confirmed_resident_cases", "resident_deaths", "confirmed_staff_cases")
inspections = c(complaints, noncomplaints)
quality = c("antipsychotic_percent", "depression_percent", "falls_percent", "pressure_ulcers_percent", "pain_percent")

# Explore new values
# Many inspections variables include 0
for (each in inspections){
  print(each)
  print(summary(df[[each]]))
}

# Most quality variables include 0
for (each in quality){
  print(each)
  print(summary(df[[each]]))
}

# Create df with inspections count data to be transformed
# transformed <- subset(df, select = c('outbreak', inspections, quality, profile))
transformed <- subset(df, select = c('outbreak', inspections, keep))



```


## Assessing skewness
We see that the inspections and number of beds data are right skewed. The quality data are not as right skewed except for antipsychotic_percent and pain_percent. 
```{r }
# Check for R skewness in numeric predictors
library(e1071)

# listofcols = c(inspections, 'number_beds', quality)
listofcols = c(inspections)

for (each in listofcols){
  print(skewness(transformed[[each]]))
  qqnorm(transformed[[each]], main = each)
  qqline(transformed[[each]], col = 'red')
}
```



```{r }
# Visualize the effect of square root and log transformations the data
library(rcompanion)

for (each in listofcols) {  
  plotNormalHistogram(x = transformed[[each]], main = each)
  plotNormalHistogram(x = sqrt(transformed[[each]]), main = c(each, 'sqrt trans'))
  plotNormalHistogram(x = log(transformed[[each]]), main = c(each, 'log trans'))
    }

```
Notes:
- Many of the numeric data are right skewed
  - Log transformations are better:
    - Total inspections data
    - Total noncomplaints
    - 5y noncomplaints
  - Sqrt transformation is better for the number_beds
  - Will have to perform sqrt transformations on the complaints and 2y noncomplaints due to zeros 
  - Will have to perform sqrt transformations on critical, withOrders, cc and ccw since these have zeros
  - For the quality data, will square root transform antipsychotic, ulcers and pain data


```{r }
# Log transform in place
# transformed[all_inspections] <- log(transformed[all_inspections])
transformed[c('total_noncomplaints', 'X5y_noncomplaints')] <- log(transformed[c('total_noncomplaints', 'X5y_noncomplaints')])

# Square root transform in place
# transformed[c(complaints, critical, withOrders, cc_ccw, "antipsychotic_percent", "pressure_ulcers_percent", "pain_percent")] <- sqrt(transformed[c(complaints, critical, withOrders, cc_ccw, "antipsychotic_percent", "pressure_ulcers_percent", "pain_percent")])
transformed[c(complaints, 'X2y_noncomplaints')] <- sqrt(transformed[c(complaints, 'X2y_noncomplaints')])

skim(transformed)

```


```{r }
# Assess the distribution of variables
xtabs(~outbreak + home_type, data=df)
xtabs(~accreditation + home_type, data=df)
xtabs(~short_stay + home_type, data=df)
xtabs(~family_council + home_type, data=df)
xtabs(~residents_council + home_type, data=df)
xtabs(~residents_council + outbreak, data=df)
xtabs(~accreditation + outbreak, data=df)
xtabs(~short_stay + outbreak, data=df)
xtabs(~family_council + outbreak, data=df)
xtabs(~family_council + residents_council, data=df)

```

## Fit the logistic regression
```{r }
# # Fit logistic regression against home type
# glm1 <- glm(outbreak~home_type, data = df2, family = 'binomial')
# summary(glm1)

# Fit logistic regression using transformed inspection counts
fit = glm(outbreak~., family=binomial, data=transformed)
summary(fit)

# transformed2 <- subset(transformed, select= c('outbreak', profile, 'X5y_complaints', 'number_beds', quality))
# transformed2_glm = glm(outbreak~., family=binomial, data=transformed2)
# summary(transformed2_glm)

```

## Backwards selection
```{r }
fit <- update(fit, .~. -X5y_critical)
summary(fit)
fit <- update(fit, .~. -X2y_withOrders)
summary(fit)
fit <- update(fit, .~. -X2y_inspections)
summary(fit)
fit <- update(fit, .~. -X2y_ccw)
summary(fit)
fit <- update(fit, .~. -pressure_ulcers_percent)
summary(fit)
fit <- update(fit, .~. -depression_percent)
summary(fit)
fit <- update(fit, .~. -total_cc)
summary(fit)
fit <- update(fit, .~. -X5y_complaints)
summary(fit)
fit <- update(fit, .~. -X5y_inspections)
summary(fit)
fit <- update(fit, .~. -residents_council)
summary(fit)
fit <- update(fit, .~. -family_council)
summary(fit)
fit <- update(fit, .~. -total_ccw)
summary(fit)
fit <- update(fit, .~. -total_withOrders)
summary(fit)
fit <- update(fit, .~. -accreditation)
summary(fit)
fit <- update(fit, .~. -falls_percent)
summary(fit)
fit <- update(fit, .~. -X2y_complaints)
summary(fit)
fit <- update(fit, .~. -X2y_cc)
summary(fit)
fit <- update(fit, .~. -X2y_critical)
summary(fit)
fit <- update(fit, .~. -short_stay)
summary(fit)
fit <- update(fit, .~. -antipsychotic_percent)
summary(fit)
fit <- update(fit, .~. -total_critical)
summary(fit)
fit <- update(fit, .~. -X5y_ccw)
summary(fit)
fit <- update(fit, .~. -X5y_cc)
summary(fit)
fit <- update(fit, .~. -X5y_withOrders)
summary(fit)
fit <- update(fit, .~. -pain_percent)
summary(fit)

```

## Fit the logistic regression 2
```{r }
# Fit logistic regression using transformed inspection counts
fit = glm(outbreak~., family=binomial, data=transformed)
summary(fit)
```

## Backwards Selection 2
```{r }
fit <- update(fit, .~. -total_noncomplaints)
summary(fit)
fit <- update(fit, .~. -X2y_complaints)
summary(fit)
fit <- update(fit, .~. -X2y_noncomplaints)
summary(fit)
fit <- update(fit, .~. -total_complaints)
summary(fit)
fit <- update(fit, .~. -X5y_noncomplaints)
summary(fit)

```

We see above that when the region data are included complaints within the last 5 years becomes a significant factor. 

## Fit the logistic regression 3
```{r }
# Fit logistic regression using transformed inspection counts
fit = glm(outbreak~., family=binomial, data=transformed)
summary(fit)
```

```{r }

fit <- update(fit, .~. -X2y_complaints)
summary(fit)
fit <- update(fit, .~. -X2y_noncomplaints)
summary(fit)
fit <- update(fit, .~. -X5y_noncomplaints)
summary(fit)
fit <- update(fit, .~. -X5y_complaints)
summary(fit)
```

When the region data are removed form the regression total complaints and non_complaints become significant factors. 
```{r }
# Calculate McFadden's pseudo R2 3
ll.null <- fit$null.deviance/-2
ll.proposed <- fit$deviance/-2
print((ll.null - ll.proposed)/ll.null)
1 - pchisq(2*(ll.proposed - ll.null), df = (length(fit$coefficients)-1)) #pvalue
```


```{r }
# Calculate McFadden's pseudo R2 2
ll.null <- fit$null.deviance/-2
ll.proposed <- fit$deviance/-2
print((ll.null - ll.proposed)/ll.null)
1 - pchisq(2*(ll.proposed - ll.null), df = (length(fit$coefficients)-1)) #pvalue
```


```{r }
# Calculate McFadden's pseudo R2 1
ll.null <- fit$null.deviance/-2
ll.proposed <- fit$deviance/-2
print((ll.null - ll.proposed)/ll.null)
1 - pchisq(2*(ll.proposed - ll.null), df = (length(fit$coefficients)-1)) #pvalue

```

## Visualize the model
```{r }
# Create a new dataframe showing probability of outbreak and outbreak status
predicted.data <- data.frame(probability.of.outbreak=fit$fitted.values, outbreak=transformed$outbreak)

# Sort the above df
predicted.data <- predicted.data[order(predicted.data$probability.of.outbreak, decreasing=FALSE),]

# Add new col to df with rank
predicted.data$rank <- 1:nrow(predicted.data)

library(ggplot2)
library(cowplot)

ggplot(data = predicted.data, aes(x=rank, y=probability.of.outbreak)) +
  geom_point(aes(color=outbreak), alpha = 0.5, shape = 4, stroke = 1) +
  xlab("Index") + ylab("Predicted probability of an outbreak") +
  ggtitle("Outbreak Status Ordered By Predicted Probability of an Outbreak") + 
  scale_color_manual(values = c('blue', 'red'))

```

```{r }

```

```{r }

```

```{r }

```

```{r }

```

```{r }

```

